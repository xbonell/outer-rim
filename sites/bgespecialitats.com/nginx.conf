server {
    listen       80;
    server_name  localhost;

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_min_length 1000;
    gzip_disable "msie6";

    root   /usr/share/nginx/html;
    index  index.html index.htm;

    # Custom 404 error page - language-specific handling
    # Serves /ca/404 or /es/404 based on URL path or Accept-Language header
    error_page 404 @language_404;

    location @language_404 {
        # Check if URL path starts with /ca/ - serve Catalan 404
        if ($request_uri ~ ^/ca/) {
            rewrite ^(.*)$ /ca/404 last;
        }
        # Check if URL path starts with /es/ - serve Spanish 404
        if ($request_uri ~ ^/es/) {
            rewrite ^(.*)$ /es/404 last;
        }
        # Check if URL path starts with /en/ - default to Spanish 404
        if ($request_uri ~ ^/en/) {
            rewrite ^(.*)$ /es/404 last;
        }
        # For root-level 404s, check Accept-Language header
        if ($http_accept_language ~* ^ca) {
            rewrite ^(.*)$ /ca/404 last;
        }
        # Default to Spanish 404
        rewrite ^(.*)$ /es/404 last;
    }

    # Location blocks to serve the actual 404 pages with try_files fallbacks
    location = /ca/404 {
        add_header X-Robots-Tag "noindex, nofollow" always;
        try_files /ca/404 /ca/404.html /ca/404/index.html =404;
    }

    location = /es/404 {
        add_header X-Robots-Tag "noindex, nofollow" always;
        try_files /es/404 /es/404.html /es/404/index.html =404;
    }

    # Cache static assets with long expiration times
    # CSS files - cache for 1 year
    location ~* \.(css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # JavaScript files - cache for 1 year
    location ~* \.(js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # Web fonts - cache for 1 year
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        add_header Access-Control-Allow-Origin "*";
        try_files $uri =404;
    }

    # Images - cache for 1 year (webp, jpg, jpeg, png, gif, svg, ico)
    location ~* \.(webp|jpg|jpeg|png|gif|svg|ico)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    location / {
        try_files $uri $uri/ =404;
    }

    # Error pages for other status codes
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
